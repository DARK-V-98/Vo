{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user's profile within the Affectionately app.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "displayName": {
          "type": "string",
          "description": "The user's chosen display name."
        },
        "bio": {
          "type": "string",
          "description": "A short biography or description provided by the user."
        },
        "interests": {
          "type": "array",
          "description": "List of interests associated with the user.",
          "items": {
            "type": "string"
          }
        },
        "photoUrl": {
          "type": "string",
          "description": "URL of the user's profile photo.",
          "format": "uri"
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        }
      },
      "required": [
        "id",
        "displayName"
      ]
    },
    "Match": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Match",
      "type": "object",
      "description": "Represents a match between two users.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Match entity."
        },
        "user1Id": {
          "type": "string",
          "description": "Reference to UserProfile of the first user in the match. (Relationship: UserProfile 1:N Match)"
        },
        "user2Id": {
          "type": "string",
          "description": "Reference to UserProfile of the second user in the match. (Relationship: UserProfile 1:N Match)"
        },
        "matchDate": {
          "type": "string",
          "description": "The date and time when the match was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "user1Id",
        "user2Id",
        "matchDate"
      ]
    },
    "Message": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Message",
      "type": "object",
      "description": "Represents a message exchanged between two users.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Message entity."
        },
        "senderId": {
          "type": "string",
          "description": "Reference to UserProfile of the message sender. (Relationship: UserProfile 1:N Message)"
        },
        "recipientId": {
          "type": "string",
          "description": "Reference to UserProfile of the message recipient. (Relationship: UserProfile 1:N Message)"
        },
        "content": {
          "type": "string",
          "description": "The text content of the message."
        },
        "timestamp": {
          "type": "string",
          "description": "The date and time when the message was sent.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "senderId",
        "recipientId",
        "content",
        "timestamp"
      ]
    },
    "InterestGroup": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "InterestGroup",
      "type": "object",
      "description": "Represents a group based on shared interests.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the InterestGroup entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the interest group."
        },
        "description": {
          "type": "string",
          "description": "A description of the interest group."
        },
        "creatorId": {
          "type": "string",
          "description": "Reference to UserProfile who created the group. (Relationship: UserProfile 1:N InterestGroup)"
        },
        "memberIds": {
          "type": "array",
          "description": "References to UserProfiles who are members of the group. (Relationship: InterestGroup N:N UserProfile)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "creatorId"
      ]
    },
    "Event": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Event",
      "type": "object",
      "description": "Represents an event organized within the app.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Event entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the event."
        },
        "description": {
          "type": "string",
          "description": "A description of the event."
        },
        "dateTime": {
          "type": "string",
          "description": "The date and time of the event.",
          "format": "date-time"
        },
        "location": {
          "type": "string",
          "description": "The location of the event."
        },
        "organizerId": {
          "type": "string",
          "description": "Reference to UserProfile who organized the event. (Relationship: UserProfile 1:N Event)"
        },
        "attendeeIds": {
          "type": "array",
          "description": "References to UserProfiles who are attending the event. (Relationship: Event N:N UserProfile)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "dateTime",
        "location",
        "organizerId"
      ]
    },
    "SharedJournalEntry": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SharedJournalEntry",
      "type": "object",
      "description": "Represents an entry in the shared journal between two users.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SharedJournalEntry entity."
        },
        "user1Id": {
          "type": "string",
          "description": "Reference to the first user in the journal entry. (Relationship: UserProfile 1:N SharedJournalEntry)"
        },
        "user2Id": {
          "type": "string",
          "description": "Reference to the second user in the journal entry. (Relationship: UserProfile 1:N SharedJournalEntry)"
        },
        "entryDate": {
          "type": "string",
          "description": "The date of the journal entry.",
          "format": "date-time"
        },
        "content": {
          "type": "string",
          "description": "The content of the journal entry."
        },
        "mood": {
          "type": "string",
          "description": "The mood of the user on the day of the journal entry."
        }
      },
      "required": [
        "id",
        "user1Id",
        "user2Id",
        "entryDate",
        "content"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}/profile",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information. Only the user can access their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/matches/{matchId}",
        "definition": {
          "entityName": "Match",
          "schema": {
            "$ref": "#/backend/entities/Match"
          },
          "description": "Stores match data between two users. Access is restricted to the two matched users.",
          "params": [
            {
              "name": "matchId",
              "description": "The unique identifier of the match."
            }
          ]
        }
      },
      {
        "path": "/matches/{matchId}/messages/{messageId}",
        "definition": {
          "entityName": "Message",
          "schema": {
            "$ref": "#/backend/entities/Message"
          },
          "description": "Stores messages exchanged between two users in a match. Includes denormalized 'senderId' and 'recipientId' for authorization independence.",
          "params": [
            {
              "name": "matchId",
              "description": "The unique identifier of the match."
            },
            {
              "name": "messageId",
              "description": "The unique identifier of the message."
            }
          ]
        }
      },
      {
        "path": "/interestGroups/{interestGroupId}",
        "definition": {
          "entityName": "InterestGroup",
          "schema": {
            "$ref": "#/backend/entities/InterestGroup"
          },
          "description": "Stores interest group data. Access is controlled by the creator and members of the group.",
          "params": [
            {
              "name": "interestGroupId",
              "description": "The unique identifier of the interest group."
            }
          ]
        }
      },
      {
        "path": "/events/{eventId}",
        "definition": {
          "entityName": "Event",
          "schema": {
            "$ref": "#/backend/entities/Event"
          },
          "description": "Stores event data. Access is controlled by the organizer and attendees of the event.",
          "params": [
            {
              "name": "eventId",
              "description": "The unique identifier of the event."
            }
          ]
        }
      },
      {
        "path": "/sharedJournalEntries/{entryId}",
        "definition": {
          "entityName": "SharedJournalEntry",
          "schema": {
            "$ref": "#/backend/entities/SharedJournalEntry"
          },
          "description": "Stores shared journal entries between two users. Access is restricted to the two users sharing the journal.",
          "params": [
            {
              "name": "entryId",
              "description": "The unique identifier of the shared journal entry."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure authorization independence, clarity, and scalability, adhering to the principles of DBAC (Database-Based Access Control) and QAPs (Queries are not filters). It leverages denormalization and structural segregation to simplify security rules and support atomic operations.\n\n**Authorization Independence and QAPs (Queries are not Filters):**\n*   **Matches Collection:** The `/matches/{matchId}` collection stores match data. Security rules ensure that only the two matched users can access match documents. `user1Id` and `user2Id` are used in rules to verify access.\n*   **Messages Subcollection:** Messages are stored in a subcollection `/matches/{matchId}/messages/{messageId}`.  Crucially, each message contains `senderId` and `recipientId`. This denormalization allows security rules to independently verify that either the sender or recipient matches the authenticated user, **without relying on parent document data**.  This is CRITICAL for authorization independence.\n*   **Interest Groups:** Interest groups are stored in the `/interestGroups/{interestGroupId}` collection. Access control is managed through the `creatorId` and `memberIds` fields. The creator always has edit access. The `memberIds` allows read access to members. The AI monitored discussions are simple to secure because all data resides in a single document.\n*   **Events:** Events are stored in the `/events/{eventId}` collection. Similar to interest groups, access control is managed through the `organizerId` and `attendeeIds` fields.\n*   **Shared Journal Entries:** Shared journal entries are stored in the `/sharedJournalEntries/{entryId}` collection. The `user1Id` and `user2Id` fields are used to control access.  These are top-level collections, enabling secure list operations using only the `request.auth.uid` and the fields in the documents themselves.\n\n**Structural Segregation:**\nThe design avoids mixing data with different access needs in the same collection. User profiles are stored separately from match data, messages, interest groups, events, and shared journal entries. This segregation simplifies security rules by ensuring that all documents within a collection share the same security posture.\n\n**Access Modeling:**\n*   **Private Data:** User profiles (`/users/{userId}/profile`) utilize path-based ownership, ensuring that only the authenticated user can access their own profile data.  The profile id is generated during user creation.\n*   **Collaborative Data:** Matches, Interest Groups, Events, and Shared Journal Entries use a combination of creator/organizer/user ID fields and lists of member/attendee IDs to manage access. This membership model facilitates collaboration while maintaining clear ownership and access controls.\n\n**Data Clarity and Predictability:**\nThe schema enforces strict naming conventions and uses explicit fields like `creatorId`, `organizerId`, `user1Id`, `user2Id`, `memberIds`, and `attendeeIds` to represent relationships and access rights. This makes the structure more predictable and easier to understand, contributing to improved debuggability and maintainability."
  }
}