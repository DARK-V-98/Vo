
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    // For the shared journal and moods, we'll make it open for now.
    function isCouple() {
      return true;
    }
    
    match /sharedJournal/vishu-oshi/entries/{entryId} {
      allow read, write: if isCouple();
    }

    match /moods/{date} {
      allow read, write: if isCouple();
    }
    
    // Previous rules...
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    function isExistingDoc() {
      return resource != null;
    }
    function isParticipant(docData) {
      return isSignedIn() && (request.auth.uid == docData.user1Id || request.auth.uid == docData.user2Id);
    }
    function isGroupCreator(docData) {
      return isSignedIn() && request.auth.uid == docData.creatorId;
    }
    function isGroupMemberOrCreator(docData) {
      return isGroupCreator(docData) || (request.auth.uid in docData.memberIds);
    }
    function isEventOrganizer(docData) {
      return isSignedIn() && request.auth.uid == docData.organizerId;
    }
    function isEventAttendeeOrOrganizer(docData) {
      return isEventOrganizer(docData) || (request.auth.uid in docData.attendeeIds);
    }
    function isMessageSender(docData) {
      return isSignedIn() && request.auth.uid == docData.senderId;
    }
    match /users/{userId}/profile/{profileId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && isExistingDoc() && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId) && isExistingDoc();
    }
    match /matches/{matchId} {
      allow get: if isParticipant(resource.data);
      allow list: if false; 
      allow create: if isParticipant(request.resource.data);
      allow update: if false;
      allow delete: if isParticipant(resource.data) && isExistingDoc();
    }
    match /matches/{matchId}/messages/{messageId} {
      allow get, list: if isParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data);
      allow create: if isMessageSender(request.resource.data) && isParticipant(get(/databases/$(database)/documents/matches/$(matchId)).data);
      allow update: if isMessageSender(resource.data) && isExistingDoc() && request.resource.data.senderId == resource.data.senderId && request.resource.data.recipientId == resource.data.recipientId;
      allow delete: if isMessageSender(resource.data) && isExistingDoc();
    }
    match /interestGroups/{interestGroupId} {
      allow get: if isGroupMemberOrCreator(resource.data);
      allow list: if false;
      allow create: if isGroupCreator(request.resource.data);
      allow update: if isGroupCreator(resource.data) && isExistingDoc() && request.resource.data.creatorId == resource.data.creatorId;
      allow delete: if isGroupCreator(resource.data) && isExistingDoc();
    }
    match /events/{eventId} {
      allow get: if isEventAttendeeOrOrganizer(resource.data);
      allow list: if false;
      allow create: if isEventOrganizer(request.resource.data);
      allow update: if isEventOrganizer(resource.data) && isExistingDoc() && request.resource.data.organizerId == resource.data.organizerId;
      allow delete: if isEventOrganizer(resource.data) && isExistingDoc();
    }
  }
}
